name: DNS Infrastructure CI

# CI/CD Pipeline - Automatic triggers
#on:
#  pull_request:
#    paths:
#      - '**/*.tf'
#  push:
#    branches: [ main ]
#    paths:
#      - '**/*.tf'
#  schedule:
#    - cron: '17 3 * * *' # Daily drift check (plan only)

# Manual trigger for testing
on:
   workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      TF_IN_AUTOMATION: "true"
      # Cloudflare (optionnel)
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      # OVH Provider
      OVH_APPLICATION_KEY: ${{ secrets.OVH_APPLICATION_KEY }}
      OVH_APPLICATION_SECRET: ${{ secrets.OVH_APPLICATION_SECRET }}
      OVH_CONSUMER_KEY: ${{ secrets.OVH_CONSUMER_KEY }}
      OVH_ENDPOINT: ${{ secrets.OVH_ENDPOINT || 'ovh-eu' }}
      # Infomaniak (optionnel)
      INFOMANIAK_TOKEN: ${{ secrets.INFOMANIAK_TOKEN }}
      # Backend Storage
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}
      AWS_EC2_METADATA_DISABLED: true
      # OVH Object Storage
      OVH_ACCESS_KEY: ${{ secrets.OVH_ACCESS_KEY }}
      OVH_SECRET_KEY: ${{ secrets.OVH_SECRET_KEY }}
      # Terraform Cloud
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
      # Azure (optionnel)
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      # GCP (optionnel)
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
      GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
      GOOGLE_REGION: ${{ secrets.GOOGLE_REGION || 'us-central1' }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
          terraform_wrapper: false

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars << EOF
          # DNS Providers
          cloudflare_api_token = "${{ secrets.CLOUDFLARE_API_TOKEN || '' }}"
          infomaniak_token = "${{ secrets.INFOMANIAK_TOKEN || '' }}"
          
          # OVH Provider
          ovh_application_key = "${{ secrets.OVH_APPLICATION_KEY || '' }}"
          ovh_application_secret = "${{ secrets.OVH_APPLICATION_SECRET || '' }}"
          ovh_consumer_key = "${{ secrets.OVH_CONSUMER_KEY || '' }}"
          ovh_endpoint = "${{ secrets.OVH_ENDPOINT || 'ovh-eu' }}"
          EOF

      - name: Init
        run: terraform init -upgrade

      - name: Validate
        run: terraform validate

      - name: Plan (PR & drift)
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        run: terraform plan

      - name: Apply (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve